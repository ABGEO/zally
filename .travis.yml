sudo: required

language: java

jdk:
  - oraclejdk8

env:
  global:
    - secure: "pQKxhst2J1Gj+IY93C4792Tzdiwf83AIoxq2ooz5z675Lp5R5p0/cwY3jwHWbRJSAizj4gv1OBohWNXMniQoW6KgUfWtuE/Gy0ubl0D/qbsGoKPPyKDrb7GFDMxn6ZjAPO0ayWpPFH5C5v8I1F2ORlX5PdAL0BGc41phkJnm+/DBwYeEdKH9uQJCgCdUWcrQVd27n9gq2/X9Jj1LGPeYvjCy8xqS+3gfE7XQpoQFza1+Lks+diW45gAQzPGR26j5Hs7mCfya90wxR/c1HA/RrrlV/BEkdAdjhGesFA6sO/yaPczcwdVa6L5tx4uBWTpytRIJNBqGmrQjz9gaCQTYRfGPN0zOSK6/agg6/lJaHbtDABNU39RsxGs83CQxHZYwj+yhZi0jYfMWVUM16Nk66t827AO969L5Xv0fDpDdz0D4cffJCM/syEkv4ICzQoIc2KiQ4Je/tT2/TDeFWuIYCkspHG4y5WzrX741yUDAkELk3WhdLEwYwdYClFz/v8EvAUqTQU2g1nCN4WqY6/gukuaeW+axw3wV0uTa1/BH72xpf60Xlz7132yS+9DJFqVC92zWBMnRYwmcdkz4c5XUWPNQxcV7i0YRF1d44Y8li7seJfg6oinGp0pP6NqB/2Jp1MhGT3Ghj+abvapMxN8B5VEeOklL30SNeGO19z5agcE="

before_install:
  - sudo add-apt-repository ppa:duggan/bats --yes
  - sudo apt-get update -qq
  - sudo apt-get install -qq bats

  # Codacy coverage
  - curl -sL https://github.com/jpm4j/jpm4j.installers/raw/master/dist/biz.aQute.jpm.run.jar >jpm4j.jar
  - java -jar jpm4j.jar -u init
  - ~/jpm/bin/jpm install com.codacy:codacy-coverage-reporter:assembly
  # / Codacy coverage

install: true

script:
  # Unit-test and build CLI tool
  - cd cli/
  - ./gradlew build --info
  - cd ..

  # Unit-test and build server
  - cd server/
  - ./gradlew build --info
  - cd ..

  # Launch local zally server
  - cd server/
  - echo "spring.profiles.active=dev" > application.properties
  - ./gradlew bootRun > /dev/null &
  - echo $! > /tmp/zally_server.pid
  - cd ..

  # Wait until Spring Boot will start
  - while ! echo "GET / HTTP/1.0\n" | nc localhost 8080; do sleep 3; done

  # Run CLI integration test
  - ./cli/integration_tests/tests.bats

  # Kill Zally server instace
  - kill -9 `cat /tmp/zally_server.pid`
  - echo $CODACY_PROJECT_TOKEN

after_success:
  - ~/jpm/bin/codacy-coverage-reporter -l Java -r build/reports/jacoco/test/jacocoTestReport.xml
